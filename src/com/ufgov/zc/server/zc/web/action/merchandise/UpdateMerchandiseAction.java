package com.ufgov.zc.server.zc.web.action.merchandise;import java.math.BigDecimal;import java.util.ArrayList;import java.util.Collection;import java.util.Enumeration;import java.util.Hashtable;import java.util.Iterator;import java.util.List;import java.util.Map;import javax.servlet.http.HttpServletRequest;import javax.servlet.http.HttpServletResponse;import org.apache.commons.logging.Log;import org.apache.commons.logging.LogFactory;import org.apache.struts.action.ActionForm;import org.apache.struts.action.ActionForward;import org.apache.struts.action.ActionMapping;import org.apache.struts.upload.FormFile;import org.apache.struts.upload.MultipartRequestHandler;import com.ufgov.zc.common.system.Guid;import com.ufgov.zc.common.system.model.AsFile;import com.ufgov.zc.common.zc.model.ZcBMerDiscountWeb;import com.ufgov.zc.common.zc.model.ZcBMerPic;import com.ufgov.zc.server.system.SpringContext;import com.ufgov.zc.server.system.service.IAsFileService;import com.ufgov.zc.server.zc.service.IMenuGoodsService;import com.ufgov.zc.server.zc.service.IZcBrandService;import com.ufgov.zc.server.zc.web.action.StrutsAction;import com.ufgov.zc.server.zc.web.form.MerchandiseForm;public class UpdateMerchandiseAction extends StrutsAction {  private final static Log log = LogFactory.getLog(UpdateMerchandiseAction.class);  public ActionForward execute(ActionMapping mapping, ActionForm form, HttpServletRequest request,  HttpServletResponse response) throws Exception {    String forword = "success";    //request.setCharacterEncoding("UTF-8");    try {      Map map = request.getParameterMap();      MerchandiseForm merchandiseForm = (MerchandiseForm) form;      IMenuGoodsService menuGoodsService = (IMenuGoodsService) this.getWebApplicationContext().getBean("menuGoodsService");      IAsFileService asFileService = (IAsFileService) SpringContext.getBean("asFileService");      merchandiseForm.getZcBMerchandise().setZcMerStatus("0"); //商品状态      merchandiseForm.getZcBMerchandise().setZcMdType("1");      merchandiseForm.getZcBMerchandise().setZcCatalogueYear("2011");      String mername = merchandiseForm.getZcBMerchandise().getZcMerName();      //根据品牌编码查找品牌名称      IZcBrandService zcBrandService = (IZcBrandService) this.getWebApplicationContext().getBean("zcBrandService");      String zcBraCode = merchandiseForm.getZcBMerchandise().getZcBraCode();      String zcBraName = zcBrandService.getBrandInfoByBrandId(zcBraCode).getZcBraName();      merchandiseForm.getZcBMerchandise().setZcBraName(zcBraName);      //			mername = new String(mername.getBytes("ISO8859-1"),"GBK");      System.out.println("-----------修改品牌的名称------------" + mername);      //jdk1.4对map的循环，并向商品品目属性表中插入数据      ZcBMerDiscountWeb zcBMerDiscount = new ZcBMerDiscountWeb();      Iterator it = map.entrySet().iterator();      List indexList = new ArrayList();      List oldIndexList = new ArrayList();      while (it.hasNext()) {        Map.Entry entry = (Map.Entry) it.next();        String key = entry.getKey().toString();        if (key.length() > 16) {          if (key.substring(0, 16).equals("zcBCatalogueProp") && !key.substring(17).equals("zcCatalogueCode")) {            if (entry.getValue() instanceof String[]) {              String[] values = (String[]) entry.getValue();              for (int i = 0; i < values.length; i++) {                String cataPropEnName = key.substring(17);                merchandiseForm.getZcBMerCatalogueProp().setZcMerCode(merchandiseForm.getZcBMerchandise().getZcMerCode());                merchandiseForm.getZcBMerCatalogueProp().setZcCatalogueCode(merchandiseForm.getZcBMerchandise().getZcCatalogueCode());                merchandiseForm.getZcBMerCatalogueProp().setZcCataPropEnName(cataPropEnName);                merchandiseForm.getZcBMerCatalogueProp().setZcCataPropValue(values[i]);                if (merchandiseForm.getZcBMerCatalogueProp() != null && !"".equals(merchandiseForm.getZcBMerCatalogueProp())) {                  menuGoodsService.updateMerchandiseNWForCataProp(merchandiseForm);                }              }            }          }          if (key.substring(0, 12).equals("zcEbSupplier") && key.substring(15, 16).equals(".")) {            if (indexList.size() <= 0) {              indexList.add(key.substring(13, 14));            } else {              if (!key.substring(13, 14).equals("-") && !indexList.contains(key.substring(13, 14))) {                indexList.add(key.substring(13, 14));              }            }          }          if (key.substring(0, 13).equals("zcEbSupplier1")) {            if (oldIndexList.size() <= 0) {              oldIndexList.add(key.substring(14, 15));            } else {              if (!key.substring(14, 15).equals("-") && !oldIndexList.contains(key.substring(14, 15))) {                oldIndexList.add(key.substring(14, 15));              }            }          }        }      }      //进行对商品折扣率信息的维护操作      System.out.println("====新增条数====" + indexList.size());      System.out.println("====数据库条数====" + oldIndexList.size());      //先按照商品编码删除改商品的所有折扣率      menuGoodsService.deleteZcBMerDiscountWeb(merchandiseForm.getZcBMerchandise().getZcMerCode());      //向数据库中添加新增的条数      for (int a = 0; a < indexList.size(); a++) {        Enumeration test = request.getParameterNames();        String name = null;        while (test.hasMoreElements()) {          name = (String) test.nextElement();          if (name.length() > 16) {            if (name.substring(13, 14).equals(indexList.get(a).toString())) {              zcBMerDiscount.setZcMerCode(merchandiseForm.getZcBMerchandise().getZcMerCode());              if (name.substring(16).equals("supplierCode")) {                zcBMerDiscount.setZcSuCode(request.getParameter(name));              }              if (name.substring(16).equals("lower")) {                zcBMerDiscount.setZcTreatyLowerLimit(Integer.parseInt(request.getParameter(name)));              }              if (name.substring(16).equals("upper")) {                zcBMerDiscount.setZcTreatyUpperLimit(Integer.parseInt(request.getParameter(name)));              }              if (name.substring(16).equals("discount")) {                zcBMerDiscount.setZcTreatyDiscountRate(new BigDecimal(request.getParameter(name)));              }              if (name.substring(16).equals("memo")) {                zcBMerDiscount.setZcTreatyMemo(request.getParameter(name));              }            }          }        }        System.out.println("--a-" + a + "-----mercode-[" + zcBMerDiscount.getZcMerCode() + "]-lower-[" + zcBMerDiscount.getZcTreatyLowerLimit()          + "]-sucode-[" + zcBMerDiscount.getZcSuCode() + "]-upper-[" + zcBMerDiscount.getZcTreatyUpperLimit());        menuGoodsService.addZcBMerDiscountWeb(zcBMerDiscount);      }      //将原来数据库进行修改后的重新插入数据库      for (int a = 0; a < oldIndexList.size(); a++) {        Enumeration test = request.getParameterNames();        String name = null;        while (test.hasMoreElements()) {          name = (String) test.nextElement();          if (name.length() > 17) {            if (name.substring(14, 15).equals(oldIndexList.get(a).toString())) {              zcBMerDiscount.setZcMerCode(merchandiseForm.getZcBMerchandise().getZcMerCode());              if (name.substring(17).equals("supplierCode")) {                zcBMerDiscount.setZcSuCode(request.getParameter(name));              }              if (name.substring(17).equals("lower")) {                zcBMerDiscount.setZcTreatyLowerLimit(Integer.parseInt(request.getParameter(name)));              }              if (name.substring(17).equals("upper")) {                zcBMerDiscount.setZcTreatyUpperLimit(Integer.parseInt(request.getParameter(name)));              }              if (name.substring(17).equals("discount")) {                zcBMerDiscount.setZcTreatyDiscountRate(new BigDecimal(request.getParameter(name)));              }              if (name.substring(17).equals("memo")) {                zcBMerDiscount.setZcTreatyMemo(request.getParameter(name));              }            }          }        }        System.out.println("--a-" + a + "-----mercode-[" + zcBMerDiscount.getZcMerCode() + "]-lower-[" + zcBMerDiscount.getZcTreatyLowerLimit()          + "]-sucode-[" + zcBMerDiscount.getZcSuCode() + "]-upper-[" + zcBMerDiscount.getZcTreatyUpperLimit());        menuGoodsService.addZcBMerDiscountWeb(zcBMerDiscount);      }      //对商品的图片信息进行处理，首先将商品和图片的关系表插入数据，然后将图片信息插入到asfile表中      //menuGoodsService.deleteZcMerPic(merchandiseForm.getZcBMerchandise().getZcMerCode()); //首先删除表中该商品的所有图片关联信息      MultipartRequestHandler multipartRequestHandler = form.getMultipartRequestHandler();      Hashtable elements = multipartRequestHandler.getFileElements();      Collection values = elements.values();      for (java.util.Iterator i = values.iterator(); i.hasNext();) {        FormFile file = (org.apache.struts.upload.FormFile) i.next();// 取得上传的文件        if ("" != file.toString() && !"".equals(file.getFileName())) {          AsFile asFile = new AsFile();          ZcBMerPic zcBMerPic = new ZcBMerPic();          String fname = file.getFileName();// 获取文件名          //String type = file.getContentType(); //获取文件类型          byte[] fileContent = file.getFileData();          String fileID = Guid.genID();          asFile.setFileId(fileID);          asFile.setFileName(fname);          asFile.setFileContent(fileContent);          asFile.setMimeType("application/octet-stream");          asFileService.uploadFile(asFile); //首先将图片插入到asfile表中          zcBMerPic.setZcMerCode(merchandiseForm.getZcBMerchandise().getZcMerCode());          zcBMerPic.setZcPicID(fileID);          menuGoodsService.addZcMerPic(zcBMerPic); //插入该商品最新的与asfile表的关联信息        }      }      menuGoodsService.updateMerchandiseNW(merchandiseForm); //修改商品的基本信息    } catch (Exception e) {      log.error(e);      throw e;    }    return mapping.findForward(forword);  }}