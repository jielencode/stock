<?xml version="1.0" encoding="UTF-8" ?>


<!DOCTYPE sqlMap

        PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"

        "http://ibatis.apache.org/dtd/sql-map-2.dtd">


<sqlMap namespace="ZcEbReqPack">

	<typeAlias alias="ZcEbPack" type="com.ufgov.zc.common.zc.model.ZcEbPack" />
	<typeAlias alias="elementCondition"
		type="com.ufgov.zc.common.system.dto.ElementConditionDto" />

	<resultMap class="ZcEbPack" id="ZcEbPackResult">

		<result property="packCode" column="PACK_CODE" />

		<result property="packName" column="PACK_NAME" />

		<result property="purContent" column="PUR_CONTENT" />

		<result property="packBudget" column="PACK_BUDGET" jdbcType="DECIMAL"

			javaType="java.math.BigDecimal" />

		<result property="entrustCode" column="ENTRUST_CODE" />

		<result property="isCheckQualification" column="IS_CHECK_QUALIFICATION" />

		<result property="purType" column="PUR_TYPE" />

		<result property="analyseType" column="ANALYSE_TYPE" />

		<result property="bidLocation" column="BID_LOCATION" />

		<result property="bidDeposit" column="BID_DEPOSIT" />

		<result property="bidDocPrice" column="BID_DOC_PRICE" />

		<result property="isFailed" column="IS_FAILED" />

		<result property="techRequire" column="TECH_REQUIRE" />

		<result property="qualificationRequire" column="QUALIFICATION_REQUIRE" />

		<result property="packDesc" column="PACK_DESC" />

		<result property="status" column="STATUS" />

		<result property="isSeleSupplier" column="IS_SELE_SUPPLIER" />

		<result property="seleType" column="SELE_TYPE" />

		<result property="seleNum" column="SELE_NUM" />

		<result property="isShowBudget" column="IS_SHOW_BUDGET" />

		<result property="failedReason" column="FAILED_REASON" />
		<result property="reqFileId" column="REQ_FILE_ID" />
		<result property="reqFileName" column="REQ_FILE_NAME" />
		<result property="formulaFileId" column="FORMULA_FILE_ID" />
		<result property="formulaFileName" column="FORMULA_FILE_NAME" />
		<result property="lastStatus" column="LAST_STATUS" />

		<!-- ZcEbEntrust -->

		<result property="entrust.sn" column="SN" />

		<result property="entrust.zcMakeCode" column="ZC_MAKE_CODE" />

		<result property="entrust.zcMakeName" column="ZC_MAKE_NAME" />

		<result property="entrust.coCode" column="CO_CODE" />

		<result property="entrust.nd" column="ND" />

		<result property="entrust.zcMakeLinkman" column="ZC_MAKE_LINKMAN" />

		<result property="entrust.zcMakeTel" column="ZC_MAKE_TEL" />

		<result property="entrust.zcInputCode" column="ZC_INPUT_CODE" />

		<result property="entrust.zcInputDate" column="ZC_INPUT_DATE" />

		<result property="entrust.zcMoneyBiSum" column="ZC_MONEY_BI_SUM" />

		<result property="entrust.remark" column="REMARK" />

		<result property="entrust.processInstId" column="PROCESS_INST_ID" />

		<result property="entrust.agency" column="AGENCY" />

		<result property="entrust.zcPifuCgfs" column="ZC_PIFU_CGFS" />

		<result property="entrust.agencyName" column="AGENCY_NAME" />

		<result property="entrust.zcDiyuDaima" column="ZC_DIYU_DAIMA" />

		<result property="entrust.zcWeitoDate" column="ZC_WEITO_DATE" />

		<result property="entrust.zcIsNotary" column="ZC_IS_NOTARY" />

		<result property="entrust.zcIsImp" column="ZC_IS_IMP" />

		<result property="entrust.zcImpFile" column="ZC_IMP_FILE" />

		<result property="entrust.zcImpFileBlobid" column="ZC_IMP_FILE_BLOBID" />

		<result property="entrust.untreadReason" column="UNTREAD_REASON" />

		<result property="entrust.executeDate" column="EXECUTE_DATE" />

		<result property="entrust.leaderId" column="LEADER_ID" />

		<result property="entrust.leaderTel" column="LEADER_TEL" />

		<result property="entrust.orgCode" column="ORG_CODE" />

		<result property="entrust.snCode" column="sn_code" />

	</resultMap>

	<resultMap class="ZcEbPack" id="ZcEbPackResult1">

		<result property="packCode" column="PACK_CODE" />

		<result property="packName" column="PACK_NAME" />

		<result property="purContent" column="PUR_CONTENT" />

		<result property="packBudget" column="PACK_BUDGET" jdbcType="DECIMAL"

			javaType="java.math.BigDecimal" />

		<result property="entrustCode" column="ENTRUST_CODE" />

		<result property="isCheckQualification" column="IS_CHECK_QUALIFICATION" />

		<result property="purType" column="PUR_TYPE" />

		<result property="analyseType" column="ANALYSE_TYPE" />

		<result property="bidLocation" column="BID_LOCATION" />

		<result property="bidDeposit" column="BID_DEPOSIT" />

		<result property="bidDocPrice" column="BID_DOC_PRICE" />

		<result property="isFailed" column="IS_FAILED" />

		<result property="techRequire" column="TECH_REQUIRE" />

		<result property="qualificationRequire" column="QUALIFICATION_REQUIRE" />

		<result property="packDesc" column="PACK_DESC" />

		<result property="status" column="STATUS" />

		<result property="isSeleSupplier" column="IS_SELE_SUPPLIER" />

		<result property="seleType" column="SELE_TYPE" />

		<result property="seleNum" column="SELE_NUM" />

		<result property="isShowBudget" column="IS_SHOW_BUDGET" />

		<result property="failedReason" column="FAILED_REASON" />
		<result property="reqFileId" column="REQ_FILE_ID" />
		<result property="reqFileName" column="REQ_FILE_NAME" />
		<result property="formulaFileId" column="FORMULA_FILE_ID" />
		<result property="formulaFileName" column="FORMULA_FILE_NAME" />
		<result property="lastStatus" column="LAST_STATUS" />
		<result property="attn" column="ATTN" />
		<result property="attnName" column="ATTN_NAME" />
		<result property="attnPhone" column="ATTN_PHONE" />
		<result property="attnEmail" column="ATTN_EMAIL" />
		<result property="attnFax" column="ATTN_FAX" />
		<result property="manager" column="MANAGER" />
		<result property="managerName" column="MANAGER_NAME" />
		<result property="managerPhone" column="MANAGER_PHONE" />
		<result property="managerEmail" column="MANAGER_EMAIL" />
		<result property="managerFax" column="MANAGER_FAX" />
		<!-- ZcEbEntrust -->

		<result property="entrust.sn" column="SN" />

		<result property="entrust.zcMakeCode" column="ZC_MAKE_CODE" />

		<result property="entrust.zcMakeName" column="ZC_MAKE_NAME" />

		<result property="entrust.coCode" column="CO_CODE" />

		<result property="entrust.nd" column="ND" />

		<result property="entrust.zcMakeLinkman" column="ZC_MAKE_LINKMAN" />

		<result property="entrust.zcMakeTel" column="ZC_MAKE_TEL" />

		<result property="entrust.zcInputCode" column="ZC_INPUT_CODE" />

		<result property="entrust.zcInputDate" column="ZC_INPUT_DATE" />

		<result property="entrust.zcMoneyBiSum" column="ZC_MONEY_BI_SUM" />

		<result property="entrust.remark" column="REMARK" />

		<result property="entrust.processInstId" column="PROCESS_INST_ID" />

		<result property="entrust.agency" column="AGENCY" />

		<result property="entrust.zcPifuCgfs" column="ZC_PIFU_CGFS" />

		<result property="entrust.agencyName" column="AGENCY_NAME" />

		<result property="entrust.zcDiyuDaima" column="ZC_DIYU_DAIMA" />

		<result property="entrust.zcWeitoDate" column="ZC_WEITO_DATE" />

		<result property="entrust.zcIsNotary" column="ZC_IS_NOTARY" />

		<result property="entrust.zcIsImp" column="ZC_IS_IMP" />

		<result property="entrust.zcImpFile" column="ZC_IMP_FILE" />

		<result property="entrust.zcImpFileBlobid" column="ZC_IMP_FILE_BLOBID" />

		<result property="entrust.untreadReason" column="UNTREAD_REASON" />

		<result property="entrust.executeDate" column="EXECUTE_DATE" />

		<result property="entrust.leaderId" column="LEADER_ID" />

		<result property="entrust.leaderTel" column="LEADER_TEL" />

		<result property="entrust.orgCode" column="ORG_CODE" />

		<result property="entrust.snCode" column="sn_code" />

		<result property="entrust.isCar" column="is_car" />

	</resultMap>

	<select id="getZcEbPack" resultMap="ZcEbPackResult"

		parameterClass="elementCondition">

		select

		master.PACK_CODE,

		master.PUR_CONTENT,

		master.PACK_NAME,

		master.PACK_BUDGET,

		master.ENTRUST_CODE,

		master.IS_CHECK_QUALIFICATION,

		master.PUR_TYPE,

		master.ANALYSE_TYPE,

		master.BID_LOCATION,

		master.BID_DEPOSIT,

		master.BID_DOC_PRICE,

		master.IS_FAILED,

		master.TECH_REQUIRE,

		master.QUALIFICATION_REQUIRE,

		master.PACK_DESC,

		master.STATUS,

		master.IS_SELE_SUPPLIER,

		master.SELE_TYPE,

		master.SELE_NUM,

		master.IS_SHOW_BUDGET,

		master.FAILED_REASON,

		master.LAST_STATUS,
		master.REQ_FILE_ID,
		master.REQ_FILE_NAME,
		master.FORMULA_FILE_ID,
		master.FORMULA_FILE_NAME,
		e.*

		from

		ZC_EB_REQ_PACK
		master,

		ZC_EB_ENTRUST e

		where master.status!='cancel'
		and
		master.ENTRUST_CODE=e.SN(+)

		<isNotNull prepend="and" property="dattr1">

			master.PROJ_CODE=#dattr1:VARCHAR#

		</isNotNull>

		order by

		to_number(master.PACK_CODE)

	</select>

	<select id="getZcEbPackListByEntrustCode" resultMap="ZcEbPackResult"

		parameterClass="string">

		select

		master.PACK_CODE,

		master.PUR_CONTENT,

		master.PACK_NAME,

		master.PACK_BUDGET,

		master.ENTRUST_CODE,

		master.IS_CHECK_QUALIFICATION,

		master.PUR_TYPE,

		master.ANALYSE_TYPE,

		master.BID_LOCATION,

		master.BID_DEPOSIT,

		master.BID_DOC_PRICE,

		master.IS_FAILED,

		master.TECH_REQUIRE,

		master.QUALIFICATION_REQUIRE,

		master.PACK_DESC,

		master.STATUS,

		master.IS_SELE_SUPPLIER,

		master.SELE_TYPE,

		master.SELE_NUM,

		master.IS_SHOW_BUDGET,

		master.FAILED_REASON,

		master.LAST_STATUS,
		master.REQ_FILE_ID,
		master.REQ_FILE_NAME,
		master.FORMULA_FILE_ID,
		master.FORMULA_FILE_NAME,

		e.*

		from

		ZC_EB_REQ_PACK master,

		ZC_EB_ENTRUST e

		where

		e.SN (+)=

		master.ENTRUST_CODE

		and

		master.ENTRUST_CODE=#value#

		order by

		to_number(master.PACK_CODE)

	</select>

	<select id="getZcEbPackByPackCode" resultMap="ZcEbPackResult"

		parameterClass="string">
		select
		master.PACK_CODE,
		master.PUR_CONTENT,
		master.PACK_NAME,
		master.PACK_BUDGET,
		master.ENTRUST_CODE,
		master.IS_CHECK_QUALIFICATION,
		master.PUR_TYPE,
		master.ANALYSE_TYPE,
		master.BID_LOCATION,
		master.BID_DEPOSIT,

		master.BID_DOC_PRICE,

		master.IS_FAILED,

		master.TECH_REQUIRE,

		master.QUALIFICATION_REQUIRE,

		master.PACK_DESC,

		master.STATUS,

		master.IS_SELE_SUPPLIER,

		master.SELE_TYPE,

		master.SELE_NUM,

		master.IS_SHOW_BUDGET,

		master.FAILED_REASON,

		master.LAST_STATUS,
		master.REQ_FILE_ID,
		master.REQ_FILE_NAME,
		master.FORMULA_FILE_ID,
		master.FORMULA_FILE_NAME,
		e.*
		from
		ZC_EB_REQ_PACK master,
		ZC_EB_ENTRUST e
		where
		e.SN (+)=
		master.ENTRUST_CODE
		and
		master.PACK_CODE=#value#
		and
		master.status!='cancel'
	</select>
	<insert id="insertZcEbPackBySeq" parameterClass="ZcEbPack">

		<selectKey resultClass="String" keyProperty="packCode">

			select

			ZC_SEQ_PACK.NEXTVAL AS ID from DUAL

		</selectKey>

		insert into ZC_EB_REQ_PACK (PACK_CODE, PUR_CONTENT, PACK_NAME,

		PACK_BUDGET, ENTRUST_CODE,

		IS_CHECK_QUALIFICATION, PUR_TYPE,

		ANALYSE_TYPE, BID_LOCATION, BID_DEPOSIT, IS_FAILED,

		TECH_REQUIRE,

		QUALIFICATION_REQUIRE, PACK_DESC, STATUS,

		IS_SELE_SUPPLIER, SELE_TYPE,

		SELE_NUM,IS_SHOW_BUDGET,CO_CODE,ND)
		values
		(#packCode:VARCHAR#,
		#purContent:VARCHAR#,
		#packName:VARCHAR#,

		#packBudget:DECIMAL#,
		#entrustCode:VARCHAR#,

		#isCheckQualification:VARCHAR#,

		#purType:VARCHAR#,

		#analyseType:VARCHAR#, #bidLocation:VARCHAR#,

		#bidDeposit:DECIMAL#,

		#isFailed:VARCHAR#, #techRequire:VARCHAR#,

		#qualificationRequire:VARCHAR#,

		#packDesc:VARCHAR#,

		#status:VARCHAR#,

		#isSeleSupplier:VARCHAR#, #seleType:VARCHAR#,

		#seleNum:DECIMAL#,#isShowBudget:VARCHAR#,#entrust.coCode#,#entrust.nd#)

	</insert>
	<insert id="insertZcEbPack" parameterClass="ZcEbPack">

		insert into

		ZC_EB_REQ_PACK (PACK_CODE, PUR_CONTENT, PACK_NAME,

		PACK_BUDGET,

		ENTRUST_CODE,

		IS_CHECK_QUALIFICATION, PUR_TYPE, ANALYSE_TYPE,

		BID_LOCATION, BID_DEPOSIT, IS_FAILED,

		TECH_REQUIRE,

		QUALIFICATION_REQUIRE, PACK_DESC, STATUS,

		IS_SELE_SUPPLIER, SELE_TYPE,

		SELE_NUM,IS_SHOW_BUDGET,CO_CODE,ND,REQ_FILE_ID,REQ_FILE_NAME,FORMULA_FILE_ID,FORMULA_FILE_NAME,REQ_CODE)

		values

		(#packCode:VARCHAR#,
		#purContent:VARCHAR#,

		#packName:VARCHAR#,

		#packBudget:DECIMAL#, #entrustCode:VARCHAR#,

		#isCheckQualification:VARCHAR#,

		#purType:VARCHAR#,

		#analyseType:VARCHAR#, #bidLocation:VARCHAR#,

		#bidDeposit:DECIMAL#,

		#isFailed:VARCHAR#, #techRequire:VARCHAR#,

		#qualificationRequire:VARCHAR#,

		#packDesc:VARCHAR#,
		#status:VARCHAR#,
		#isSeleSupplier:VARCHAR#, #seleType:VARCHAR#,
		#seleNum:DECIMAL#,#isShowBudget:VARCHAR#,#entrust.coCode#,#entrust.nd#,
		#reqFileId:VARCHAR#,#reqFileName:VARCHAR#,#formulaFileId:VARCHAR#,#formulaFileName:VARCHAR#,#reqCode:VARCHAR#)
	</insert>
	<delete id="deleteZcEbPackByEntrustCode" parameterClass="string">
		delete
		from
		ZC_EB_REQ_PACK
		where REQ_CODE = #value#
	</delete>
	<delete id="deleteZcEbPackByPackCode" parameterClass="string">
		delete from
		ZC_EB_REQ_PACK
		where PACK_CODE = #value#
	</delete>
	<delete id="deleteZcEbPackReqByEntrustCode" parameterClass="string">
		delete
		from ZC_EB_REQ_PACK
		where PROJ_CODE = #value#
	</delete>
	<delete id="deleteZcEbPackReqByPackReqCode" parameterClass="string">
		delete
		from ZC_EB_REQ_PACK
		where PACK_REQ_CODE = #value#

	</delete>
	<select id="getZcEbPackByEntrustCode" resultMap="ZcEbPackResult"
		parameterClass="elementCondition">

		select

		master.PACK_CODE,

		master.PUR_CONTENT,

		master.PACK_NAME,

		master.PACK_BUDGET,

		master.ENTRUST_CODE,

		master.IS_CHECK_QUALIFICATION,
		
		
		
		

		master.PUR_TYPE,

		master.ANALYSE_TYPE,

		master.BID_LOCATION,

		master.BID_DEPOSIT,

		master.BID_DOC_PRICE,

		master.IS_FAILED,

		master.TECH_REQUIRE,

		master.QUALIFICATION_REQUIRE,

		master.PACK_DESC,

		master.STATUS,

		master.IS_SELE_SUPPLIER,

		master.SELE_TYPE,

		master.SELE_NUM,

		master.IS_SHOW_BUDGET,

		master.FAILED_REASON,

		master.LAST_STATUS,
		master.REQ_FILE_ID,
		master.REQ_FILE_NAME,
		master.FORMULA_FILE_ID,
		master.FORMULA_FILE_NAME,
		e.*

		from

		ZC_EB_REQ_PACK
		master,

		ZC_EB_ENTRUST e

		where

		e.SN (+)=
		master.ENTRUST_CODE
		<isNotNull prepend="AND" property="zcText0">
			master.REQ_CODE=#zcText0#
		</isNotNull>
		order by master.pack_code
	</select>


	<select id="getZcEbPackByZcMakeCode" resultMap="ZcEbPackResult"
		parameterClass="string">
		select

		master.PACK_CODE,

		master.PUR_CONTENT,

		master.PACK_NAME,

		master.PACK_BUDGET,

		master.ENTRUST_CODE,

		master.IS_CHECK_QUALIFICATION,

		master.PUR_TYPE,

		master.ANALYSE_TYPE,

		master.BID_LOCATION,

		master.BID_DEPOSIT,

		master.BID_DOC_PRICE,

		master.IS_FAILED,

		master.TECH_REQUIRE,

		master.QUALIFICATION_REQUIRE,

		master.PACK_DESC,

		master.STATUS,

		master.IS_SELE_SUPPLIER,

		master.SELE_TYPE,

		master.SELE_NUM,

		master.IS_SHOW_BUDGET,

		master.FAILED_REASON,

		master.LAST_STATUS,
		master.REQ_FILE_ID,
		master.REQ_FILE_NAME,
		master.FORMULA_FILE_ID,
		master.FORMULA_FILE_NAME,
		e.*
		from
		ZC_EB_REQ_PACK master,
		ZC_EB_ENTRUST e
		where
		e.SN
		(+)=master.ENTRUST_CODE
		AND e.ZC_MAKE_CODE=#value#
	</select>
	<select id="getZcEbPackListByJingBanRen" resultMap="ZcEbPackResult1"
		parameterClass="elementCondition">

		SELECT MASTER.PACK_CODE,

		MASTER.PUR_CONTENT,

		MASTER.PACK_NAME,

		MASTER.PACK_BUDGET,

		MASTER.ENTRUST_CODE,

		MASTER.IS_CHECK_QUALIFICATION,

		nvl(zc_v_pro_pack.PUR_TYPE,v_zc_p_pro_make.PUR_TYPE)  PUR_TYPE,
		MASTER.ANALYSE_TYPE,

		MASTER.BID_LOCATION,

		MASTER.BID_DEPOSIT,

		MASTER.BID_DOC_PRICE,

		MASTER.IS_FAILED,

		MASTER.TECH_REQUIRE,

		MASTER.QUALIFICATION_REQUIRE,

		MASTER.PACK_DESC,

		MASTER.STATUS,

		MASTER.IS_SELE_SUPPLIER,

		MASTER.SELE_TYPE,

		MASTER.SELE_NUM,

		MASTER.IS_SHOW_BUDGET,

		MASTER.FAILED_REASON,

		MASTER.LAST_STATUS,
		master.REQ_FILE_ID,
		master.REQ_FILE_NAME,
		master.FORMULA_FILE_ID,
		master.FORMULA_FILE_NAME,
		E.*,
		ZC_EB_DUTY_AUDIT_SHEET.ATTN,
		ZC_EB_DUTY_AUDIT_SHEET.ATTN_NAME,
		attnUser.mobile as ATTN_PHONE,
		attnUser.email as ATTN_EMAIL,
		'' as ATTN_FAX,
		ZC_EB_DUTY_AUDIT_SHEET.SUPERINTENDENT as MANAGER,
		ZC_EB_DUTY_AUDIT_SHEET.SUPERINTENDENT_NAME as MANAGER_NAME,
		manager.mobile as MANAGER_PHONE,
		manager.email as MANAGER_EMAIL,
		'' as MANAGER_FAX
		FROM ZC_EB_REQ_PACK MASTER,
		ZC_EB_ENTRUST E,
		ZC_EB_DUTY_AUDIT_SHEET ZC_EB_DUTY_AUDIT_SHEET,
		v_zc_p_pro_make v_zc_p_pro_make,zc_v_pro_pack zc_v_pro_pack,
	    as_emp attnUser,
	    as_emp manager
		WHERE attnUser.user_id = ZC_EB_DUTY_AUDIT_SHEET.attn
		and manager.user_id = ZC_EB_DUTY_AUDIT_SHEET.SUPERINTENDENT
		and MASTER.Status != 'cancel'
		and NOT exists
		(SELECT ZC_EB_PACK.PACK_CODE
		from ZC_EB_PACK ZC_EB_PACK, ZC_EB_PROJ ZC_EB_PROJ
		where ZC_EB_PACK.PROJ_CODE = ZC_EB_PROJ.PROJ_CODE
		AND ZC_EB_PACK.PACK_CODE = MASTER.Pack_Code
		AND ZC_EB_PACK.Status != '5'
		AND ZC_EB_PACK.Status != 'cancel'
        and not exists
         (select q.ques_id
                  from zc_eb_question q, zc_eb_question_pack qp
                 where q.id = qp.id
                   and q.proj = ZC_EB_PACK.PROJ_CODE
                   and qp.packcode = ZC_EB_PACK.Pack_Code
                   and q.ques_type = #zcText1#
                   and q.handle_mode=#zcText2#
                   and q.state='exec'))
		AND E.SN = MASTER.ENTRUST_CODE
		AND ZC_EB_DUTY_AUDIT_SHEET.SN = E.SN
		and v_zc_p_pro_make.PROJ_CODE = E.ZC_MAKE_CODE
		and zc_v_pro_pack.pack_code(+) = MASTER.Pack_Code
		and exists (select er.req_code from zc_eb_requirement er where er.req_code=master.req_code and er.status='exec')
		<isNotNull prepend="and" property="purType">
		((zc_v_pro_pack.PUR_TYPE is null and v_zc_p_pro_make.PUR_TYPE=#purType#) or zc_v_pro_pack.PUR_TYPE=#purType#)
		</isNotNull>
		<isNotNull prepend="and" property="zcText0">
			E.zc_pifu_cgfs!=#zcText0#
		</isNotNull>
		<isNotNull prepend="and" property="executor">
		(ZC_EB_DUTY_AUDIT_SHEET.Superintendent=#executor# or ZC_EB_DUTY_AUDIT_SHEET.ATTN=  #executor#)
		</isNotNull>
		<isNotNull prepend="and" property="coCode">
			e.AGENCY=#coCode#
		</isNotNull>
		<isNotNull prepend="and" property="packCode">
			MASTER.PACK_CODE not in ($packCode$)
		</isNotNull>
		<include refid="BusiNumLim.BusiNumLimStr" />
	</select>
</sqlMap>
