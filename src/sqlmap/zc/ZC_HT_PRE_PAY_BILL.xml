<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="ZC_HT_PRE_PAY_BILL" >
	<typeAlias alias="elementCondition"
		type="com.ufgov.zc.common.system.dto.ElementConditionDto" />
  <resultMap id="abatorgenerated_ZcHtPrePayBillResult" class="com.ufgov.zc.common.zc.model.ZcHtPrePayBill" >
    <!--
      WARNING - This element is automatically generated by Abator for iBATIS, do not modify.
      This element was generated on Wed Aug 08 08:00:48 GMT 2012.
    -->
    <result column="BILL_CODE" property="billCode" jdbcType="VARCHAR" />
    <result column="ZC_MAKE_CODE" property="zcMakeCode" jdbcType="VARCHAR" />
    <result column="ZC_HT_CODE" property="zcHtCode" jdbcType="VARCHAR" />
    <result column="CO_CODE" property="coCode" jdbcType="VARCHAR" />
    <result column="ND" property="nd" jdbcType="DECIMAL" />
    <result column="ORG_CODE" property="orgCode" jdbcType="VARCHAR" />
    <result column="REMARK" property="remark" jdbcType="VARCHAR" />
    <result column="EXECUTOR" property="executor" jdbcType="VARCHAR" />
    <result column="STATUS" property="status" jdbcType="VARCHAR" />
    <result column="PROCESS_INST_ID" property="processInstId" jdbcType="DECIMAL" />
    <result column="EXECUTE_DATE" property="executeDate" jdbcType="DATE" />
    <result column="EXECUTOR_NAME" property="executorName" jdbcType="VARCHAR" />
     <result column="ZC_MAKE_NAME" property="zcMakeName" jdbcType="VARCHAR" />
    <result column="ZC_HT_NAME" property="zcHtName" jdbcType="VARCHAR" />
	<result column="ZC_IMP_FILE" jdbcType="VARCHAR" property="zcImpFile" />
	<result column="ZC_IMP_FILE_BLOBID" jdbcType="VARCHAR" property="zcImpFileBlobid" />
  </resultMap>
  
  <resultMap id="abatorgenerated_ZcHtPrePayBillItemResult" class="com.ufgov.zc.common.zc.model.ZcHtPrePayBillItem" >
    <result column="BILL_CODE" property="billCode" jdbcType="VARCHAR" />
    <result column="PAY_ORDER" property="payOrder" jdbcType="VARCHAR" />
    <result column="PAY_MONEY" property="payMoney" jdbcType="DECIMAL" />
    <result column="REMARK" property="remark" jdbcType="VARCHAR" />
    <result column="PERCENT" property="percent" jdbcType="VARCHAR" />
    <result column="PAY_DATE" property="payDate" jdbcType="DATE" />   
    <result column="PAY_YEAR" property="payYear" jdbcType="VARCHAR" />
    <result column="PAY_MONTH" property="payMonth" jdbcType="VARCHAR" />
    <result column="PAY_QR_CODE" property="payQrCode" jdbcType="VARCHAR" />
    <result column="status" property="status" jdbcType="VARCHAR" />
  </resultMap>
  
  
  
  <select id="getHtPrePayBillList" resultMap="abatorgenerated_ZcHtPrePayBillResult"
		parameterClass="elementCondition">
	  SELECT master.*,
         (select zp.zc_make_name
            from zc_p_pro_make zp
           where zp.zc_make_code = master.zc_make_code) ZC_MAKE_NAME,
         (select ht.zc_ht_name
            from zc_xmcg_ht ht
           where ht.zc_ht_code = master.zc_ht_code) ZC_HT_NAME
  
    FROM ZC_HT_PRE_PAY_BILL master 
    where 1=1 
		<include refid="BusiNumLim.BusiNumLimStr" />

		<isNotNull prepend="AND" property="status">
			<isEqual property="status" compareValue="todo">
				exists (select
				instance_id from v_wf_current_task_gk53 where executor =#executor#
				and instance_id = master.process_inst_id)
			</isEqual>
			<isEqual property="status" compareValue="done">
				exists (select
				instance_id from V_WF_ACTION_HISTORY_GK53 where executor =
				#executor# and instance_id = master.process_inst_id)
				and
				master.STATUS!='cancel'
				and master.STATUS!='exec'
			</isEqual>
			<isEqual property="status" compareValue="untread">
				exists (select instance_id from V_WF_CURRENT_TASK_ZC_UNTREAD where
				executor =#executor# and instance_id = master.process_inst_id)
			</isEqual>
			<isEqual property="status" compareValue="exec">
				(master.STATUS ='exec')
			</isEqual>
			<isEqual property="status" compareValue="draft">
				exists (select
				WF_DRAFT_NAME from as_wf_draft where user_id=#executor# and
				compo_id=#wfcompoId# and WF_DRAFT_ID=master.process_inst_id)
				or
				master.process_inst_id = -1
			</isEqual>
			<isEqual property="status" compareValue="all">
				1=1
			</isEqual>	
		</isNotNull>
		<isNotNull prepend="AND" property="coCode">
			master.CO_CODE=#coCode:VARCHAR#
		</isNotNull>
		<isNotEqual prepend="AND" compareValue="0" property="nd">
			master.ND = #nd#
		</isNotEqual>
	</select>
	
	
	
  <select id="abatorgenerated_selectByPrimaryKey" resultMap="abatorgenerated_ZcHtPrePayBillResult" parameterClass="java.lang.String" >
    <!--
      WARNING - This element is automatically generated by Abator for iBATIS, do not modify.
      This element was generated on Wed Aug 08 08:00:48 GMT 2012.
    -->
   
 SELECT master.*,
         (select zp.zc_make_name
            from zc_p_pro_make zp
           where zp.zc_make_code = master.zc_make_code) ZC_MAKE_NAME,
         (select ht.zc_ht_name
            from zc_xmcg_ht ht
           where ht.zc_ht_code = master.zc_ht_code) ZC_HT_NAME
  
    FROM ZC_HT_PRE_PAY_BILL master
    where master.BILL_CODE = #billCode:VARCHAR#
  </select>


 <select id="abatorgenerated_selectByHtCode" resultMap="abatorgenerated_ZcHtPrePayBillResult" parameterClass="java.lang.String" >
    <!--
      WARNING - This element is automatically generated by Abator for iBATIS, do not modify.
      This element was generated on Wed Aug 08 08:00:48 GMT 2012.
    -->
 SELECT master.*,
         (select zp.zc_make_name
            from zc_p_pro_make zp
           where zp.zc_make_code = master.zc_make_code) ZC_MAKE_NAME,
         (select ht.zc_ht_name
            from zc_xmcg_ht ht
           where ht.zc_ht_code = master.zc_ht_code) ZC_HT_NAME
  
    FROM ZC_HT_PRE_PAY_BILL master
    where master.ZC_HT_CODE = #zcHtCode:VARCHAR#
  </select>
  <delete id="abatorgenerated_deleteByPrimaryKey" parameterClass="java.lang.String" >
    <!--
      WARNING - This element is automatically generated by Abator for iBATIS, do not modify.
      This element was generated on Wed Aug 08 08:00:48 GMT 2012.
    -->
    delete from ZC_HT_PRE_PAY_BILL
    where BILL_CODE = #billCode:VARCHAR#
  </delete>
 
  <insert id="abatorgenerated_insert" parameterClass="com.ufgov.zc.common.zc.model.ZcHtPrePayBill" >
    <!--
      WARNING - This element is automatically generated by Abator for iBATIS, do not modify.
      This element was generated on Wed Aug 08 08:00:48 GMT 2012.
    -->
    insert into ZC_HT_PRE_PAY_BILL (BILL_CODE, ZC_MAKE_CODE, ZC_HT_CODE, CO_CODE, ND, ORG_CODE,
      REMARK, EXECUTOR, STATUS, PROCESS_INST_ID, EXECUTE_DATE, EXECUTOR_NAME,ZC_IMP_FILE,ZC_IMP_FILE_BLOBID)
    values (#billCode:VARCHAR#, #zcMakeCode:VARCHAR#, #zcHtCode:VARCHAR#, #coCode:VARCHAR#,
      #nd:DECIMAL#, #orgCode:VARCHAR#, #remark:VARCHAR#, #executor:VARCHAR#, #status:VARCHAR#,
      #processInstId:DECIMAL#, #executeDate:DATE#, #executorName:VARCHAR#,#zcImpFile:VARCHA#,#zcImpFileBlobid:VARCHA#)
  </insert>
  <update id="abatorgenerated_updateByPrimaryKey" parameterClass="com.ufgov.zc.common.zc.model.ZcHtPrePayBill" >
  
    update ZC_HT_PRE_PAY_BILL
    set ZC_MAKE_CODE = #zcMakeCode:VARCHAR#,
      ZC_HT_CODE = #zcHtCode:VARCHAR#,
      CO_CODE = #coCode:VARCHAR#,
      ND = #nd:DECIMAL#,
      ORG_CODE = #orgCode:VARCHAR#,
      REMARK = #remark:VARCHAR#,
      EXECUTOR = #executor:VARCHAR#,
      STATUS = #status:VARCHAR#,
      PROCESS_INST_ID = #processInstId:DECIMAL#,
      EXECUTE_DATE = #executeDate:DATE#,
      EXECUTOR_NAME = #executorName:VARCHAR#,
		ZC_IMP_FILE=#zcImpFile#,
		ZC_IMP_FILE_BLOBID=#zcImpFileBlobid#
    where BILL_CODE = #billCode:VARCHAR#
  </update>
 
<!-- 子表 -->
  
  <select id="selectByBillCode" resultMap="abatorgenerated_ZcHtPrePayBillItemResult" parameterClass="java.lang.String" >
    select it.BILL_CODE, it.PAY_ORDER, it.PAY_MONEY, it.REMARK, it.PERCENT, it.PAY_DATE, to_char(it.PAY_DATE, 'YYYY') PAY_YEAR,
       to_char(it.PAY_DATE, 'MM') PAY_MONTH,
       dt.bill_code PAY_QR_CODE,
       decode(bal.zc_bal_status,'exec','5','',decode(bill.status,'exec','3','','0','2'),'4') status
  from ZC_HT_PRE_PAY_BILL_ITEM it,zc_ht_pre_pay_bill_item_dtl dt
  ,zc_ht_pre_pay_bill bill, zc_p_pro_bal bal
 where it.BILl_CODE = #billCode:VARCHAR#
 and it.bill_code=dt.ht_code(+)
 and it.pay_order=dt.pay_order(+)
 and dt.bill_code=bill.bill_code(+)
 and it.bill_code=bal.zc_ht_code(+)
 and it.pay_order=bal.pay_order(+)
 order by PAY_ORDER
  </select>
  
  <select id="selectAddQrByBillCode" resultMap="abatorgenerated_ZcHtPrePayBillItemResult" parameterClass="java.lang.String" >
    select it.BILL_CODE, it.PAY_ORDER, it.PAY_MONEY, it.REMARK, it.PERCENT, it.PAY_DATE, to_char(it.PAY_DATE, 'YYYY') PAY_YEAR,
       to_char(it.PAY_DATE, 'MM') PAY_MONTH,
       dt.bill_code PAY_QR_CODE,
       decode(bal.zc_bal_status,'exec','5','',decode(bill.status,'exec','3','','0','2'),'4') status
  from ZC_HT_PRE_PAY_BILL_ITEM it,zc_ht_pre_pay_bill_item_dtl dt
  ,zc_ht_pre_pay_bill bill, zc_p_pro_bal bal
 where it.BILl_CODE = #billCode:VARCHAR#
 and it.bill_code=dt.ht_code(+)
 and it.pay_order=dt.pay_order(+)
 and dt.bill_code=bill.bill_code(+)
 and it.bill_code=bal.zc_ht_code(+)
 and it.pay_order=bal.pay_order(+)
 order by PAY_ORDER
  </select>
  
  <select id="selectPayBillItemByBillCode" resultMap="abatorgenerated_ZcHtPrePayBillItemResult" parameterClass="java.lang.String" >
    select it.BILL_CODE, it.PAY_ORDER, it.PAY_MONEY, it.REMARK,it.PERCENT,it.PAY_DATE,to_char(it.PAY_DATE,'YYYY') PAY_YEAR, to_char(it.PAY_DATE,'MM') PAY_MONTH
    from ZC_HT_PRE_PAY_BILL_ITEM it,zc_ht_pre_pay_bill_item_dtl dt
    where it.bill_code=dt.ht_code
    and it.pay_order=dt.pay_order
    and dt.BILl_CODE=#billCode:VARCHAR#
  </select>
  <delete id="deleteByBillCode" parameterClass="java.lang.String" >
    delete from ZC_HT_PRE_PAY_BILL_ITEM
      where BILl_CODE=#billCode:VARCHAR#
  </delete>
  <insert id="abatorgenerated_insertITEM" parameterClass="com.ufgov.zc.common.zc.model.ZcHtPrePayBillItem" >
    insert into ZC_HT_PRE_PAY_BILL_ITEM (BILL_CODE, PAY_ORDER, PAY_MONEY, REMARK,PERCENT,PAY_DATE)
    values (#billCode:VARCHAR#, #payOrder:VARCHAR#, #payMoney:DECIMAL#, #remark:VARCHAR#,#percent:VARCHAR#,#payDate:DATE#)
  </insert>
  
  
  <select id="selectITEMListByHtCode" resultMap="abatorgenerated_ZcHtPrePayBillItemResult" parameterClass="java.lang.String" >
    SELECT ITEM.BILL_CODE,
         ITEM.PAY_ORDER,
         ITEM.PAY_MONEY,
         ITEM.REMARK,
         ITEM.PERCENT,
         ITEM.PAY_DATE
         ,to_char(ITEM.PAY_DATE,'YYYY') PAY_YEAR
         , to_char(ITEM.PAY_DATE,'MM') PAY_MONTH,'' PAY_QR_CODE,'' status
   FROM ZC_HT_PRE_PAY_BILL_ITEM ITEM, ZC_HT_PRE_PAY_BILL BILL
   WHERE ITEM.BILL_CODE = BILL.ZC_HT_CODE
   AND BILL.ZC_HT_CODE =#zcHtCode:VARCHAR#
  </select>
  
    <select id="selectITEMListByElement" resultMap="abatorgenerated_ZcHtPrePayBillItemResult" parameterClass="elementCondition" >
    SELECT ITEM.BILL_CODE,
         ITEM.PAY_ORDER,
         ITEM.PAY_MONEY,
         ITEM.REMARK,
         ITEM.PERCENT,
         ITEM.PAY_DATE,
         to_char(ITEM.PAY_DATE,'YYYY') PAY_YEAR,
         to_char(ITEM.PAY_DATE,'MM') PAY_MONTH,'' PAY_QR_CODE,'' status
   FROM ZC_HT_PRE_PAY_BILL_ITEM ITEM, ZC_HT_PRE_PAY_BILL BILL,ZC_HT_PRE_PAY_BILL_ITEM_dtl dt
   WHERE dt.bill_code = bill.bill_code
   and item.bill_code=dt.ht_code
   and item.pay_order=dt.pay_order
   and bill.status='exec'
   AND BILL.ZC_HT_CODE =#zcText0:VARCHAR#
   union
SELECT it.BILL_CODE,
         it.PAY_ORDER,
         it.PAY_MONEY,
         it.REMARK,
         it.PERCENT,
         it.PAY_DATE,
         to_char(it.PAY_DATE,'YYYY') PAY_YEAR,
         to_char(it.PAY_DATE,'MM') PAY_MONTH,'' PAY_QR_CODE,'' status
   FROM ZC_HT_PRE_PAY_BILL_ITEM it, zc_eb_yanshou_bill ys
   WHERE it.bill_code=ys.pack_code
   AND it.bill_code =#zcText0:VARCHAR#
   and ys.status='exec'
  </select>
  <select id="selectCoNameByCode" resultClass="String" parameterClass="String">
  select t.co_name value from ma_company t where t.co_code=#value#
  </select>
  <delete id="deleteItemDetailByBillCode" parameterClass="java.lang.String" >
    delete from zc_ht_pre_pay_bill_item_dtl
      where BILl_CODE=#billCode:VARCHAR#
  </delete>
  <insert id="abatorgenerated_insertItemDetail" parameterClass="com.ufgov.zc.common.zc.model.ZcHtPrePayBillItem" >
    insert into zc_ht_pre_pay_bill_item_dtl (BILL_CODE, HT_CODE, PAY_ORDER, IS_PAY)
    values (#payQrCode:VARCHAR#, #billCode:VARCHAR#, #payOrder:VARCHAR#, 'N')
  </insert>
</sqlMap>