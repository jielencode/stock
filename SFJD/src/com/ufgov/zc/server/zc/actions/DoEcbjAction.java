package com.ufgov.zc.server.zc.actions;import java.text.SimpleDateFormat;import java.util.Date;import java.util.HashMap;import java.util.List;import java.util.Map;import com.ufgov.zc.common.system.constants.ZcSettingConstants;import com.ufgov.zc.common.system.dto.ElementConditionDto;import com.ufgov.zc.common.system.model.AsFile;import com.ufgov.zc.common.zc.model.ZcEbEcbjPlan;import com.ufgov.zc.common.zc.model.ZcEbOpenBid;import com.ufgov.zc.server.system.SpringContext;import com.ufgov.zc.server.system.service.IAsFileService;import com.ufgov.zc.server.zc.service.IZcEbEcbjService;public class DoEcbjAction {  private Map parameterMap = new HashMap();  private Map returnMap = new HashMap();  private String functionDo = null;  private IAsFileService asFileService = null;  private IZcEbEcbjService zcEbEcbjService = null;  public DoEcbjAction(Map parameterMap, String functionDo) {    setParameterMap(parameterMap);    setFunctionDo(functionDo);    this.asFileService = (IAsFileService) SpringContext.getBean("asFileService");    this.zcEbEcbjService = (IZcEbEcbjService) SpringContext.getBean("zcEbEcbjService");  }  public void start() {    if (this.asFileService == null) {      this.returnMap.put("UPDATESTATUS", "fail");      this.returnMap.put("FAILREASON", "没有获取到asFileService实例.");      return;    }    this.returnMap.clear();    if (toCheckAllowBaoJia()) {      toFinishJobs();    }  }  private boolean toCheckAllowBaoJia() {    String packCode = (String) parameterMap.get("PACKCODE");    String projCode = (String) parameterMap.get("PROJECTCODE");    ElementConditionDto dto = new ElementConditionDto();    dto.setPackCode(packCode);    dto.setProjCode(projCode);    List list = this.zcEbEcbjService.getZcEbEcbjPlanList(dto);    int size = list.size();    if (size == 0) {      this.returnMap.put("FAILREASON", "当前标段当前没有【再次报价计划】，无法报价，参数：projCode=" + projCode + ",packCode=" + packCode);      return false;    }    //已经按照报价的轮数进行了升序排序，所以取最后一个就可以了    ZcEbEcbjPlan plan = (ZcEbEcbjPlan) list.get(list.size() - 1);    Date currTime = new Date();    SimpleDateFormat sdf = new SimpleDateFormat(ZcSettingConstants.SIMPLE_DATE_FORMAT_FULL);    if (currTime.after(plan.getEndTime())) {      this.returnMap.put("FAILREASON", "当前标段已经过了截止时间【" + sdf.format(plan.getEndTime()) + "】，无法报价...");      return false;    }    if (currTime.before(plan.getStartTime())) {      this.returnMap.put("FAILREASON", "当前标段还没有到开始时间【" + sdf.format(plan.getStartTime()) + "】...");      return false;    }    return true;  }  private void toFinishJobs() {    try {      AsFile asFile = new AsFile();      asFile.setFileContent((byte[]) parameterMap.get("FILECONTENT"));      asFile.setFileName((String) parameterMap.get("FILENAME"));      asFile.setMimeType("xml");      String fileID = this.asFileService.uploadFile(asFile);      ZcEbOpenBid bid = new ZcEbOpenBid();      bid.setTbylbFileId(fileID);      bid.setPackCode((String) parameterMap.get("PACKCODE"));      bid.setPackName((String) parameterMap.get("PACKNAME"));      bid.setProjCode((String) parameterMap.get("PROJECTCODE"));      bid.setProjName((String) parameterMap.get("PROJECTNAME"));      bid.setProviderCode((String) parameterMap.get("PROVIDERCODE"));      bid.setProviderName((String) parameterMap.get("PROVIDERNAME"));      bid.setOpenBidStatus(ZcSettingConstants.FIELD_TRANS_ZC_BJ_NO_OPEN);      bid.setTbylbFileName(asFile.getFileName());      String res = this.zcEbEcbjService.addNewPrice(bid);      if (res == null || "OK".equals(res)) {        this.returnMap.put("RESULT", "再次报价成功！");      } else {        this.returnMap.put("RESULT", "再次报价失败，原因：" + res);      }      this.returnMap.put("FILEID", fileID);    } catch (Exception e) {      e.printStackTrace();      this.returnMap.put("RESULT", "再次报价失败！" + e.getMessage());    }  }  public Map getParameterMap() {    return parameterMap;  }  public void setParameterMap(Map parameterMap) {    this.parameterMap = parameterMap;  }  public Map getReturnMap() {    return returnMap;  }  public void setReturnMap(Map returnMap) {    this.returnMap = returnMap;  }  public String getFunctionDo() {    return functionDo;  }  public void setFunctionDo(String functionDo) {    this.functionDo = functionDo;  }}